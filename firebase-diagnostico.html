<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Firebase</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Diagn√≥stico Completo do Firebase</h1>
        
        <div class="test-section">
            <h2>1. Status de Conex√£o</h2>
            <button onclick="testBasicConnection()">Testar Conex√£o B√°sica</button>
            <div id="connectionResult"></div>
        </div>
        
        <div class="test-section">
            <h2>2. Autentica√ß√£o</h2>
            <button onclick="testAuthStatus()">Verificar Status Auth</button>
            <button onclick="testCreateUser()">Testar Criar Usu√°rio</button>
            <div id="authResult"></div>
        </div>
        
        <div class="test-section">
            <h2>3. Firestore Database</h2>
            <button onclick="testFirestoreRead()">Testar Leitura</button>
            <button onclick="testFirestoreWrite()">Testar Escrita</button>
            <div id="firestoreResult"></div>
        </div>
        
        <div class="test-section">
            <h2>4. Regras de Seguran√ßa</h2>
            <button onclick="testSecurityRules()">Verificar Regras</button>
            <div id="securityResult"></div>
        </div>
        
        <div class="test-section">
            <h2>5. Log Completo</h2>
            <button onclick="clearLog()">Limpar Log</button>
            <div id="fullLog" class="log"></div>
        </div>
    </div>

    <script type="module">
        let logContent = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('fullLog').textContent = logContent;
            console.log(message);
        }
        
        window.clearLog = () => {
            logContent = '';
            document.getElementById('fullLog').textContent = '';
        };
        
        // 1. Teste de Conex√£o B√°sica
        window.testBasicConnection = async function() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = '<div class="info">Testando conex√£o...</div>';
            
            try {
                log('üîÑ Iniciando teste de conex√£o b√°sica...');
                
                // Importar Firebase
                const firebaseModule = await import('./firebase-config.js');
                log('‚úÖ Firebase importado com sucesso');
                
                // Verificar se as fun√ß√µes est√£o dispon√≠veis
                if (firebaseModule.auth) {
                    log('‚úÖ Auth dispon√≠vel');
                } else {
                    log('‚ùå Auth n√£o dispon√≠vel');
                }
                
                if (firebaseModule.db) {
                    log('‚úÖ Firestore dispon√≠vel');
                } else {
                    log('‚ùå Firestore n√£o dispon√≠vel');
                }
                
                if (firebaseModule.firebaseService) {
                    log('‚úÖ FirebaseService dispon√≠vel');
                } else {
                    log('‚ùå FirebaseService n√£o dispon√≠vel');
                }
                
                resultDiv.innerHTML = '<div class="success">‚úÖ Conex√£o b√°sica funcionando!</div>';
                
            } catch (error) {
                log(`‚ùå Erro na conex√£o: ${error.message}`);
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        };
        
        // 2. Teste de Autentica√ß√£o
        window.testAuthStatus = async function() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<div class="info">Verificando autentica√ß√£o...</div>';
            
            try {
                log('üîÑ Verificando status de autentica√ß√£o...');
                
                const { auth, onAuthStateChanged } = await import('./firebase-config.js');
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        log(`‚úÖ Usu√°rio logado: ${user.email}`);
                        resultDiv.innerHTML = `<div class="success">‚úÖ Usu√°rio logado: ${user.email}</div>`;
                    } else {
                        log('‚ÑπÔ∏è Nenhum usu√°rio logado');
                        resultDiv.innerHTML = '<div class="info">‚ÑπÔ∏è Nenhum usu√°rio logado</div>';
                    }
                });
                
            } catch (error) {
                log(`‚ùå Erro no auth: ${error.message}`);
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        };
        
        // 3. Teste de Criar Usu√°rio
        window.testCreateUser = async function() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<div class="info">Testando cria√ß√£o de usu√°rio...</div>';
            
            try {
                log('üîÑ Testando cria√ß√£o de usu√°rio...');
                
                const { firebaseService } = await import('./firebase-config.js');
                
                // Gerar dados de teste √∫nicos
                const timestamp = Date.now();
                const testEmail = `teste${timestamp}@exemplo.com`;
                const testPassword = '123456';
                
                const userData = {
                    nome: 'Usuario Teste',
                    tipo: 'cliente',
                    telefone: '(11) 99999-9999'
                };
                
                log(`üß™ Tentando criar usu√°rio: ${testEmail}`);
                
                const result = await firebaseService.signUp(testEmail, testPassword, userData);
                
                if (result.success) {
                    log(`‚úÖ Usu√°rio criado com sucesso! UID: ${result.user.uid}`);
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Usu√°rio criado com sucesso!<br>
                            Email: ${testEmail}<br>
                            UID: ${result.user.uid}
                        </div>
                    `;
                } else {
                    log(`‚ùå Erro ao criar usu√°rio: ${result.error}`);
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${result.error}</div>`;
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`);
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        };
        
        // 4. Teste de Firestore
        window.testFirestoreRead = async function() {
            const resultDiv = document.getElementById('firestoreResult');
            resultDiv.innerHTML = '<div class="info">Testando leitura do Firestore...</div>';
            
            try {
                log('üîÑ Testando leitura do Firestore...');
                
                const { db, collection, getDocs } = await import('./firebase-config.js');
                
                const querySnapshot = await getDocs(collection(db, 'users'));
                const count = querySnapshot.size;
                
                log(`‚úÖ Leitura bem-sucedida. ${count} documentos encontrados.`);
                resultDiv.innerHTML = `<div class="success">‚úÖ Leitura OK. ${count} documentos na cole√ß√£o 'users'</div>`;
                
            } catch (error) {
                log(`‚ùå Erro na leitura: ${error.message}`);
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        };
        
        window.testFirestoreWrite = async function() {
            const resultDiv = document.getElementById('firestoreResult');
            resultDiv.innerHTML = '<div class="info">Testando escrita no Firestore...</div>';
            
            try {
                log('üîÑ Testando escrita no Firestore...');
                
                const { db, collection, addDoc } = await import('./firebase-config.js');
                
                const testDoc = {
                    teste: true,
                    timestamp: new Date(),
                    message: 'Teste de escrita'
                };
                
                const docRef = await addDoc(collection(db, 'tests'), testDoc);
                
                log(`‚úÖ Escrita bem-sucedida. Doc ID: ${docRef.id}`);
                resultDiv.innerHTML = `<div class="success">‚úÖ Escrita OK. Documento criado: ${docRef.id}</div>`;
                
            } catch (error) {
                log(`‚ùå Erro na escrita: ${error.message}`);
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        };
        
        // 5. Teste de Regras de Seguran√ßa
        window.testSecurityRules = async function() {
            const resultDiv = document.getElementById('securityResult');
            resultDiv.innerHTML = '<div class="info">Verificando regras de seguran√ßa...</div>';
            
            try {
                log('üîÑ Verificando regras de seguran√ßa...');
                
                // Tentar opera√ß√µes que devem falhar sem auth
                const { db, collection, getDocs } = await import('./firebase-config.js');
                
                // Tentar ler sem autentica√ß√£o
                await getDocs(collection(db, 'users'));
                log('‚ö†Ô∏è Conseguiu ler sem autentica√ß√£o - regras podem estar muito permissivas');
                resultDiv.innerHTML = '<div class="info">‚ö†Ô∏è Regras permissivas detectadas</div>';
                
            } catch (error) {
                if (error.code === 'permission-denied') {
                    log('‚úÖ Regras de seguran√ßa funcionando (acesso negado sem auth)');
                    resultDiv.innerHTML = '<div class="success">‚úÖ Regras de seguran√ßa OK</div>';
                } else {
                    log(`‚ùå Erro inesperado: ${error.message}`);
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
                }
            }
        };
        
        // Auto-start basic connection test
        setTimeout(() => {
            testBasicConnection();
        }, 1000);
    </script>
</body>
</html>
